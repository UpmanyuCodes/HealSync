<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Doctor-Patient API Integration Test</title>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 20px;
            background: #f8fafc;
        }
        .test-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .test-section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-header {
            border-bottom: 2px solid #3b82f6;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary {
            background: #3b82f6;
            color: white;
        }
        .btn-secondary {
            background: #6b7280;
            color: white;
        }
        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .result-box {
            background: #f1f5f9;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            padding: 15px;
            margin-top: 15px;
            white-space: pre-wrap;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            border-color: #10b981;
            background: #ecfdf5;
            color: #065f46;
        }
        .error {
            border-color: #ef4444;
            background: #fef2f2;
            color: #991b1b;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Doctor-Patient API Integration Test</h1>
        <p>This page tests the new doctor-patient relationship APIs and integration features.</p>

        <!-- Test Controls -->
        <div class="test-section">
            <div class="test-header">
                <h2>Test Setup</h2>
            </div>
            <div class="test-controls">
                <input type="number" id="doctor-id-input" placeholder="Enter Doctor ID (e.g., 789)" value="789">
                <button class="btn btn-primary" onclick="setTestDoctorId()">Set Doctor ID</button>
                <button class="btn btn-secondary" onclick="clearResults()">Clear Results</button>
            </div>
            <div id="current-doctor-display"></div>
        </div>

        <!-- All Patients Test -->
        <div class="test-section">
            <div class="test-header">
                <h2>1. Get All Patients for Doctor</h2>
                <p>Tests: <code>GET /v1/healsync/doctor/{doctorId}/patients</code></p>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testGetAllPatients()">Get All Patients</button>
                <button class="btn btn-secondary" onclick="testGetAllPatientsWithSearch()">Search Patients</button>
            </div>
            <div id="all-patients-result" class="result-box"></div>
        </div>

        <!-- Active Patients Test -->
        <div class="test-section">
            <div class="test-header">
                <h2>2. Get Active Patients for Doctor</h2>
                <p>Tests: <code>GET /v1/healsync/doctor/{doctorId}/patients/active</code></p>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testGetActivePatients()">Get Active Patients</button>
                <button class="btn btn-secondary" onclick="testPopulateSelect()">Populate Select Element</button>
            </div>
            <div id="active-patients-result" class="result-box"></div>
            <select id="test-patient-select" style="width: 100%; margin-top: 10px; padding: 8px;">
                <option value="">Select will be populated here...</option>
            </select>
        </div>

        <!-- Patient Statistics Test -->
        <div class="test-section">
            <div class="test-header">
                <h2>3. Patient Statistics</h2>
                <p>Tests statistical analysis of doctor's patients</p>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testGetStatistics()">Get Patient Statistics</button>
                <button class="btn btn-secondary" onclick="testDisplayStatistics()">Display Statistics UI</button>
            </div>
            <div id="statistics-result" class="result-box"></div>
            <div id="statistics-display" class="stats-grid"></div>
        </div>

        <!-- Patient Grouping Test -->
        <div class="test-section">
            <div class="test-header">
                <h2>4. Patient Grouping by Treatment</h2>
                <p>Tests grouping patients by treatment plan status</p>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testPatientGrouping()">Group by Treatment Status</button>
            </div>
            <div id="grouping-result" class="result-box"></div>
        </div>

        <!-- Integration Test -->
        <div class="test-section">
            <div class="test-header">
                <h2>5. Full Integration Test</h2>
                <p>Tests complete workflow of doctor-patient API integration</p>
            </div>
            <div class="test-controls">
                <button class="btn btn-primary" onclick="testFullIntegration()">Run Full Test</button>
            </div>
            <div id="integration-result" class="result-box"></div>
        </div>
    </div>

    <!-- Include the API utility -->
    <script src="/JS/doctor-patient-api.js"></script>
    <script>
        let currentTestDoctorId = 789;

        function setTestDoctorId() {
            const input = document.getElementById('doctor-id-input');
            currentTestDoctorId = parseInt(input.value) || 789;
            document.getElementById('current-doctor-display').innerHTML = 
                `<p><strong>Current Test Doctor ID:</strong> ${currentTestDoctorId}</p>`;
        }

        function clearResults() {
            const resultBoxes = document.querySelectorAll('.result-box');
            resultBoxes.forEach(box => box.innerHTML = '');
            document.getElementById('statistics-display').innerHTML = '';
            document.getElementById('test-patient-select').innerHTML = '<option value="">Select will be populated here...</option>';
        }

        function updateResult(elementId, content, isError = false) {
            const element = document.getElementById(elementId);
            element.innerHTML = content;
            element.className = 'result-box ' + (isError ? 'error' : 'success');
        }

        async function testGetAllPatients() {
            try {
                updateResult('all-patients-result', 'Loading...');
                const patients = await DoctorPatientAPI.getAllPatients(currentTestDoctorId);
                updateResult('all-patients-result', 
                    `SUCCESS: Found ${patients.length} total patients\n\n` + 
                    JSON.stringify(patients, null, 2)
                );
            } catch (error) {
                updateResult('all-patients-result', 
                    `ERROR: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`, 
                    true
                );
            }
        }

        async function testGetActivePatients() {
            try {
                updateResult('active-patients-result', 'Loading...');
                const patients = await DoctorPatientAPI.getActivePatients(currentTestDoctorId);
                updateResult('active-patients-result', 
                    `SUCCESS: Found ${patients.length} active patients\n\n` + 
                    JSON.stringify(patients, null, 2)
                );
            } catch (error) {
                updateResult('active-patients-result', 
                    `ERROR: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`, 
                    true
                );
            }
        }

        async function testPopulateSelect() {
            try {
                updateResult('active-patients-result', 'Populating select element...');
                await DoctorPatientUI.populatePatientSelect('test-patient-select', currentTestDoctorId, true);
                updateResult('active-patients-result', 'SUCCESS: Select element populated with active patients');
            } catch (error) {
                updateResult('active-patients-result', 
                    `ERROR: ${error.message}`, 
                    true
                );
            }
        }

        async function testGetStatistics() {
            try {
                updateResult('statistics-result', 'Calculating statistics...');
                const stats = await DoctorPatientAPI.getPatientStatistics(currentTestDoctorId);
                updateResult('statistics-result', 
                    `SUCCESS: Statistics calculated\n\n` + 
                    JSON.stringify(stats, null, 2)
                );
            } catch (error) {
                updateResult('statistics-result', 
                    `ERROR: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`, 
                    true
                );
            }
        }

        async function testDisplayStatistics() {
            try {
                updateResult('statistics-result', 'Displaying statistics UI...');
                await DoctorPatientUI.displayPatientStatistics(currentTestDoctorId, 'statistics-display');
                updateResult('statistics-result', 'SUCCESS: Statistics UI displayed above');
            } catch (error) {
                updateResult('statistics-result', 
                    `ERROR: ${error.message}`, 
                    true
                );
            }
        }

        async function testPatientGrouping() {
            try {
                updateResult('grouping-result', 'Grouping patients by treatment status...');
                const groups = await DoctorPatientAPI.getPatientsGroupedByTreatment(currentTestDoctorId);
                updateResult('grouping-result', 
                    `SUCCESS: Patients grouped by treatment status\n\n` + 
                    `With Treatment Plans: ${groups.withTreatmentPlans.length}\n` +
                    `Without Treatment Plans: ${groups.withoutTreatmentPlans.length}\n` +
                    `Multiple Treatment Plans: ${groups.multipleTreatmentPlans.length}\n\n` +
                    JSON.stringify(groups, null, 2)
                );
            } catch (error) {
                updateResult('grouping-result', 
                    `ERROR: ${error.message}\n\nFull error: ${JSON.stringify(error, null, 2)}`, 
                    true
                );
            }
        }

        async function testGetAllPatientsWithSearch() {
            try {
                updateResult('all-patients-result', 'Searching patients...');
                const searchTerm = prompt('Enter search term (name or email):') || 'John';
                const patients = await DoctorPatientAPI.searchPatients(currentTestDoctorId, searchTerm, false);
                updateResult('all-patients-result', 
                    `SUCCESS: Search for "${searchTerm}" found ${patients.length} patients\n\n` + 
                    JSON.stringify(patients, null, 2)
                );
            } catch (error) {
                updateResult('all-patients-result', 
                    `ERROR: ${error.message}`, 
                    true
                );
            }
        }

        async function testFullIntegration() {
            const results = [];
            
            try {
                updateResult('integration-result', 'Running full integration test...\n');
                
                // Test 1: Get all patients
                results.push('1. Testing getAllPatients...');
                const allPatients = await DoctorPatientAPI.getAllPatients(currentTestDoctorId);
                results.push(`   ✓ Found ${allPatients.length} total patients`);
                
                // Test 2: Get active patients
                results.push('2. Testing getActivePatients...');
                const activePatients = await DoctorPatientAPI.getActivePatients(currentTestDoctorId);
                results.push(`   ✓ Found ${activePatients.length} active patients`);
                
                // Test 3: Get statistics
                results.push('3. Testing getPatientStatistics...');
                const stats = await DoctorPatientAPI.getPatientStatistics(currentTestDoctorId);
                results.push(`   ✓ Statistics calculated: ${stats.totalPatients} total, ${stats.activePatients} active`);
                
                // Test 4: Group by treatment
                results.push('4. Testing getPatientsGroupedByTreatment...');
                const groups = await DoctorPatientAPI.getPatientsGroupedByTreatment(currentTestDoctorId);
                results.push(`   ✓ Grouped: ${groups.withTreatmentPlans.length} with plans, ${groups.withoutTreatmentPlans.length} without`);
                
                // Test 5: Search functionality
                results.push('5. Testing searchPatients...');
                const searchResults = await DoctorPatientAPI.searchPatients(currentTestDoctorId, 'a', true);
                results.push(`   ✓ Search for "a" found ${searchResults.length} active patients`);
                
                results.push('\n🎉 ALL TESTS PASSED! Integration is working correctly.');
                updateResult('integration-result', results.join('\n'));
                
            } catch (error) {
                results.push(`\n❌ TEST FAILED: ${error.message}`);
                updateResult('integration-result', results.join('\n'), true);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            setTestDoctorId();
        });
    </script>
</body>
</html>
